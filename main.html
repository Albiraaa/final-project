<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Client API Inventaris HT (Golang + JWT)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h2 { margin-bottom: 5px; }
    .card {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
    }
    label { display: block; margin-top: 5px; }
    input, select {
      padding: 5px;
      margin-top: 3px;
      width: 250px;
      max-width: 100%;
    }
    button { margin-top: 10px; padding: 6px 10px; cursor: pointer; }
    #status { font-weight: bold; }
    #tokenBox {
      font-size: 12px;
      background: #f5f5f5;
      padding: 5px;
      word-break: break-all;
    }
    #result {
      background: #111;
      color: #0f0;
      padding: 10px;
      min-height: 120px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h1>Client API Inventaris HT (Golang + JWT)</h1>

<div class="card">
  <h2>Konfigurasi</h2>
  <input id="baseUrl" value="https://final-project-production-2cff.up.railway.app">
</div>

<div class="card">
  <h2>Login</h2>
  <input id="email" placeholder="admin@mail.com">
  <input id="password" type="password" placeholder="admin">
  <button onclick="login()">Login</button>
  <div id="status">Belum login</div>
  <div id="tokenBox">(kosong)</div>
</div>

<div class="card">
  <h2>Kelola Kategori</h2>
  <select id="kategoriIdForm"></select>
  <input id="kategoriNama" placeholder="Nama Kategori">
  <button onclick="createKategori()">POST</button>
  <button onclick="updateKategori()">PUT</button>
  <button onclick="deleteKategori()">DELETE</button>
</div>

<div class="card">
  <h2>Kelola Lokasi</h2>
  <select id="lokasiIdForm"></select>
  <input id="lokasiNama" placeholder="Nama Lokasi">
  <button onclick="createLokasi()">POST</button>
  <button onclick="updateLokasi()">PUT</button>
  <button onclick="deleteLokasi()">DELETE</button>
</div>

<div class="card">
  <h2>Kelola HT</h2>
  <select id="htIdForm"></select>
  <input id="htSerial" placeholder="Serial">
  <input id="htMerk" placeholder="Merk">
  <input id="htStatus" placeholder="Status">
  <select id="htKategoriId"></select>
  <select id="htLokasiId"></select>
  <button onclick="createHT()">POST</button>
  <button onclick="updateHT()">PUT</button>
  <button onclick="deleteHT()">DELETE</button>
</div>

<h2>Response</h2>
<pre id="result">Belum ada request</pre>

<h2>Data Kategori</h2>
<button onclick="renderKategori()">GET ALL KATEGORI</button>
<pre id="viewKategori">-</pre>

<h2>Data Lokasi</h2>
<button onclick="renderLokasi()">GET ALL LOKASI</button>
<pre id="viewLokasi">-</pre>

<h2>Data HT</h2>
<button onclick="renderHT()">GET ALL HT</button>
<pre id="viewHT">-</pre>

<script>
let token = localStorage.getItem("jwt_token");
let kategoriCache = [], lokasiCache = [], htCache = [];

const base = () => baseUrl.value.replace(/\/+$/, "");
const auth = () => ({
  "Authorization": "Bearer " + token,
  "Content-Type": "application/json"
});
const show = d => result.textContent = JSON.stringify(d, null, 2);

// ===== LOGIN =====
async function login() {
  const res = await fetch(base()+"/api/users/login", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ email:email.value, password:password.value })
  });
  const data = await res.json();
  if (!data.token) return show(data);
  token = data.token;
  localStorage.setItem("jwt_token", token);
  status.textContent = "Login berhasil âœ…";
  tokenBox.textContent = token;
  afterLoginLoad();
}

// ===== LOAD DROPDOWN =====
async function loadKategori() {
  kategoriCache = await (await fetch(base()+"/api/kategori",{headers:auth()})).json();
  kategoriIdForm.innerHTML = "<option value='' disabled selected hidden>Pilih Kategori</option>";
  htKategoriId.innerHTML = "<option value='' disabled selected hidden>Pilih Kategori</option>";
  kategoriCache.forEach(k=>{
    kategoriIdForm.innerHTML += `<option value="${k.id}">${k.nama}</option>`;
    htKategoriId.innerHTML += `<option value="${k.id}">${k.nama}</option>`;
  });
}

async function loadLokasi() {
  lokasiCache = await (await fetch(base()+"/api/lokasi",{headers:auth()})).json();
  lokasiIdForm.innerHTML = "<option value='' disabled selected hidden>Pilih Lokasi</option>";
  htLokasiId.innerHTML = "<option value='' disabled selected hidden>Pilih Lokasi</option>";
  lokasiCache.forEach(l=>{
    lokasiIdForm.innerHTML += `<option value="${l.id}">${l.nama}</option>`;
    htLokasiId.innerHTML += `<option value="${l.id}">${l.nama}</option>`;
  });
}

async function loadHT() {
  htCache = await (await fetch(base()+"/api/ht",{headers:auth()})).json();
  htIdForm.innerHTML = "<option value='' disabled selected hidden>Pilih HT</option>";
  htCache.forEach(h=>{
    htIdForm.innerHTML += `<option value="${h.id}">${h.serial} - ${h.merk}</option>`;
  });
}

async function afterLoginLoad() {
  await loadKategori();
  await loadLokasi();
  await loadHT();
}

// ===== AUTO FILL =====
kategoriIdForm.onchange = () => {
  const k = kategoriCache.find(x=>x.id==kategoriIdForm.value);
  if(k) kategoriNama.value = k.nama;
};

lokasiIdForm.onchange = () => {
  const l = lokasiCache.find(x=>x.id==lokasiIdForm.value);
  if(l) lokasiNama.value = l.nama;
};

htIdForm.onchange = () => {
  const h = htCache.find(x=>x.id==htIdForm.value);
  if(!h) return;
  htSerial.value = h.serial;
  htMerk.value = h.merk;
  htStatus.value = h.status;
  htKategoriId.value = h.kategori_id;
  htLokasiId.value = h.lokasi_id;
};

// ===== CRUD =====
const post = async (p, b) => {
  const res = await fetch(base()+p,{
    method:"POST",
    headers:auth(),
    body:JSON.stringify(b)
  });
  const data = await res.json();
  show(data);
  refreshAll();
};
const put = async (p, b) => {
  const res = await fetch(base()+p,{
    method:"PUT",
    headers:auth(),
    body:JSON.stringify(b)
  });
  const data = await res.json();
  show(data);
  refreshAll();
};
const del = async (p) => {
  const res = await fetch(base()+p,{
    method:"DELETE",
    headers:auth()
  });
  const data = await res.json();
  show(data);
  refreshAll();
};

const createKategori = ()=>post("/api/kategori",{nama:kategoriNama.value});
const updateKategori = ()=>put("/api/kategori/"+kategoriIdForm.value,{nama:kategoriNama.value});
const deleteKategori = ()=>del("/api/kategori/"+kategoriIdForm.value);

const createLokasi = ()=>post("/api/lokasi",{nama:lokasiNama.value});
const updateLokasi = ()=>put("/api/lokasi/"+lokasiIdForm.value,{nama:lokasiNama.value});
const deleteLokasi = ()=>del("/api/lokasi/"+lokasiIdForm.value);

const createHT = ()=>post("/api/ht",{
  serial:htSerial.value, merk:htMerk.value, status:htStatus.value,
  kategori_id:Number(htKategoriId.value),
  lokasi_id:Number(htLokasiId.value)
});
const updateHT = ()=>put("/api/ht/"+htIdForm.value,{
  serial:htSerial.value, merk:htMerk.value, status:htStatus.value,
  kategori_id:Number(htKategoriId.value),
  lokasi_id:Number(htLokasiId.value)
});
const deleteHT = ()=>del("/api/ht/"+htIdForm.value);

async function refreshAll() {
  await loadKategori();
  await loadLokasi();
  await loadHT();
}

// ===== RENDER GET ALL =====
function renderKategori() {
  let out = "";
  kategoriCache.forEach(k => {
    out += `ID: ${k.id}\nNama: ${k.nama}\n------------------\n`;
  });
  viewKategori.textContent = out || "Data kosong";
}

function renderLokasi() {
  let out = "";
  lokasiCache.forEach(l => {
    out += `ID: ${l.id}\nNama: ${l.nama}\n------------------\n`;
  });
  viewLokasi.textContent = out || "Data kosong";
}

function renderHT() {
  let out = "";
  htCache.forEach(h => {
    const kat = kategoriCache.find(k=>k.id==h.kategori_id)?.nama || "-";
    const lok = lokasiCache.find(l=>l.id==h.lokasi_id)?.nama || "-";
    out +=
`ID: ${h.id}
Serial: ${h.serial}
Merk: ${h.merk}
Status: ${h.status}
Kategori: ${kat}
Lokasi: ${lok}
------------------\n`;
  });
  viewHT.textContent = out || "Data kosong";
}

// ===== GET BY ID (AUTO SAAT PILIH) =====
kategoriIdForm.onchange = () => {
  const k = kategoriCache.find(x=>x.id==kategoriIdForm.value);
  if (!k) return;
  kategoriNama.value = k.nama;
  viewKategori.textContent =
`ID: ${k.id}
Nama: ${k.nama}`;
};

lokasiIdForm.onchange = () => {
  const l = lokasiCache.find(x=>x.id==lokasiIdForm.value);
  if (!l) return;
  lokasiNama.value = l.nama;
  viewLokasi.textContent =
`ID: ${l.id}
Nama: ${l.nama}`;
};

htIdForm.onchange = () => {
  const h = htCache.find(x=>x.id==htIdForm.value);
  if (!h) return;

  htSerial.value = h.serial;
  htMerk.value = h.merk;
  htStatus.value = h.status;
  htKategoriId.value = h.kategori_id;
  htLokasiId.value = h.lokasi_id;

  const kat = kategoriCache.find(k=>k.id==h.kategori_id)?.nama || "-";
  const lok = lokasiCache.find(l=>l.id==h.lokasi_id)?.nama || "-";

  viewHT.textContent =
`ID: ${h.id}
Serial: ${h.serial}
Merk: ${h.merk}
Status: ${h.status}
Kategori: ${kat}
Lokasi: ${lok}`;
};
</script>



</body>
</html>
